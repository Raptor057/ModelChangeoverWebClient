name: $(Build.BuildId)

trigger:
  branches:
    include:
    - master
  paths:
    include:
      - /version

pr:
  branches:
    include:
      - master

variables:
  IMAGE_NAME: gtm-model-change-over-webclient
  HARBOR_REGISTRY: 192.168.0.110
  HARBOR_PROJECT: gtm-model-changeover

stages:

  - stage: ReadVersion
    displayName: 'Leer versi√≥n del archivo version'
    jobs:
      - job: GetTag
        displayName: 'Leer y exponer IMAGE_TAG'
        pool:
          name: Deployment-Linux-Agents
        steps:
          - checkout: self

          - script: |
              VERSION=$(cat "$(Build.SourcesDirectory)/version")
              TAG=$(echo "$VERSION" | sed 's/[^a-zA-Z0-9._-]/_/g')
              echo "üì¶ Versi√≥n original: $VERSION"
              echo "üè∑Ô∏è  Tag sanitizado: $TAG"
              echo "##vso[task.setvariable variable=IMAGE_TAG;isOutput=true]$TAG"
            name: SetImageTag
            displayName: 'Leer y sanitizar VERSION'

  - stage: BuildAndPush
    displayName: 'Build y push de imagen a Harbor en MXSRVGLPI'
    dependsOn: ReadVersion
    variables:
      IMAGE_TAG: $[ stageDependencies.ReadVersion.GetTag.outputs['SetImageTag.IMAGE_TAG'] ]
    jobs:
      - job: BuildImage
        pool:
          name: Deployment-Linux-Agents
        steps:
          - checkout: self
            submodules: true

          - script: |
              echo "$(HARBOR_PASSWORD)" | docker login $(HARBOR_REGISTRY) \
                --username "robot\$root-user" \
                --password-stdin
            displayName: "Login en Harbor"
            env:
              HARBOR_PASSWORD: $(HARBOR_PASSWORD)
              
          - script: |
              docker build \
                -f ModelChangeoverWebClient/Dockerfile \
                -t $(HARBOR_REGISTRY)/$(HARBOR_PROJECT)/$(IMAGE_NAME):$(IMAGE_TAG) \
                --build-arg BASE_PATH="" \
                ModelChangeoverWebClient
            displayName: "Build imagen Docker"

          - script: |
              docker push $(HARBOR_REGISTRY)/$(HARBOR_PROJECT)/$(IMAGE_NAME):$(IMAGE_TAG)
            displayName: "Push a Harbor"

  - stage: DeployProduction
    displayName: 'Despliegue en producci√≥n (MXGROGU)'
    dependsOn: ExtractArtifact
    jobs:
      - job: DeployMXGROGU
        displayName: 'Desplegar en MXGROGU (prueba)'
        pool:
          name: Deployment-Linux-Agents
        steps:
          - script: echo "üëã Hola mundo desde el job MXGROGU"
            displayName: 'Imprimir hola mundo'